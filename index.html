<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Filmes para Kodi</title>
    <!-- Tailwind CSS CDN para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter para uma tipografia moderna e legível -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Define a família de fontes para o corpo do documento */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilização personalizada da barra de rolagem para melhor estética */
        ::-webkit-scrollbar {
            width: 8px; /* Largura da barra de rolagem */
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; /* Cor do fundo da trilha */
            border-radius: 10px; /* Borda arredondada da trilha */
        }
        ::-webkit-scrollbar-thumb {
            background: #888; /* Cor do "polegar" da barra de rolagem */
            border-radius: 10px; /* Borda arredondada do "polegar" */
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; /* Cor do "polegar" ao passar o mouse */
        }
        /* Estilo para limitar o texto a 3 linhas */
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 3;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 to-purple-900 min-h-screen text-gray-100 flex items-center justify-center p-4">
    <div class="container mx-auto bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-4xl">
        <h1 class="text-4xl font-bold text-center mb-8 text-blue-300">Gerador de Filmes para Kodi</h1>

        <!-- Seção de Busca de Filmes -->
        <div class="mb-8 p-6 bg-gray-700 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold mb-4 text-blue-200">1. Buscar Filmes</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="movieSearchInput" placeholder="Digite o título do filme..." class="flex-grow p-3 rounded-lg bg-gray-600 border border-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-white placeholder-gray-300">
                <button id="searchMovieButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
                    <!-- Ícone de busca SVG -->
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    Buscar Filme
                </button>
            </div>
            <!-- Área para exibir os resultados da busca -->
            <div id="searchResults" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                <!-- Resultados da busca aparecerão aqui dinamicamente -->
            </div>
            <!-- Mensagem de status da busca (ex: "Buscando...", "Nenhum encontrado") -->
            <p id="searchMessage" class="text-sm text-gray-400 mt-4 text-center hidden">Aguardando busca...</p>
        </div>

        <!-- Seção de Filmes Adicionados -->
        <div class="mb-8 p-6 bg-gray-700 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold mb-4 text-blue-200">2. Filmes Adicionados</h2>
            <div id="addedMoviesContainer" class="space-y-6">
                <!-- Mensagem exibida quando não há filmes adicionados -->
                <p id="noMoviesMessage" class="text-center text-gray-400">Nenhum filme adicionado ainda.</p>
                <!-- Filmes adicionados aparecerão aqui dinamicamente -->
            </div>
        </div>

        <!-- Seção de Saída Gerada -->
        <div class="p-6 bg-gray-700 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold mb-4 text-blue-200">3. Conteúdo Gerado para Kodi</h2>

            <!-- Opção de seleção da estrutura de saída (will, BXL ou allan) -->
            <div class="mb-4">
                <label class="text-gray-300 text-sm mb-2 block">Selecione a Estrutura de Saída (para Links Magnet):</label>
                <div class="flex flex-wrap gap-4">
                    <label class="inline-flex items-center">
                        <input type="radio" class="form-radio text-purple-600 output-structure-radio" name="outputStructure" value="will" checked>
                        <span class="ml-2 text-white">Estrutura 'will' (Padrão)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" class="form-radio text-blue-600 output-structure-radio" name="outputStructure" value="BXL">
                        <span class="ml-2 text-white">Estrutura 'BXL' (Personalizada)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" class="form-radio text-green-600 output-structure-radio" name="outputStructure" value="allan">
                        <span class="ml-2 text-white">Estrutura 'allan'</span>
                    </label>
                </div>
            </div>

            <!-- Área de texto para exibir o conteúdo gerado -->
            <textarea id="generatedOutput" rows="15" class="w-full p-4 rounded-lg bg-gray-900 border border-gray-700 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y" placeholder="O conteúdo gerado para o Kodi aparecerá aqui."></textarea>
            <button id="copyOutputButton" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full flex items-center justify-center">
                <!-- Ícone de copiar SVG -->
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-4 0V3a1 1 0 00-1-1H9a1 1 0 00-1 1v2m-1 5l3 3m0 0l3-3m-3 3V10"></path></svg>
                Copiar Texto Gerado
            </button>
        </div>
    </div>

    <script>
        // Define as constantes para acesso à API do TMDB
        const TMDB_API_KEY = '6d0edef9aa6ad31de0b398ac01a89d4d'; // Chave da API do TMDB fornecida
        const BASE_TMDB_URL = 'https://api.themoviedb.org/3'; // URL base para a API do TMDB
        const BASE_POSTER_URL = 'https://image.tmdb.org/t/p/w500'; // URL base para imagens de pôsteres (tamanho 500px de largura)

        // Array para armazenar os filmes que foram adicionados pelo usuário
        let addedMovies = [];
        // Variável global para controlar a estrutura de saída
        let currentOutputStructure = 'will'; // Padrão: 'will' (Links Magnet)

        // Referências aos elementos do DOM para manipulação via JavaScript
        const movieSearchInput = document.getElementById('movieSearchInput');
        const searchMovieButton = document.getElementById('searchMovieButton');
        const searchResultsDiv = document.getElementById('searchResults');
        const addedMoviesContainer = document.getElementById('addedMoviesContainer');
        const generatedOutputTextarea = document.getElementById('generatedOutput');
        const copyOutputButton = document.getElementById('copyOutputButton');
        const noMoviesMessage = document.getElementById('noMoviesMessage');
        const searchMessage = document.getElementById('searchMessage');

        /**
         * Realiza uma busca de filmes na API do TMDB com base em um título.
         * Exibe os resultados da busca na interface do usuário.
         * Se o TMDB não encontrar resultados, oferece links para Google e IMDb.
         * @param {string} query - O título do filme a ser buscado.
         */
        async function searchMovies(query) {
            // Se a query estiver vazia, limpa os resultados e exibe uma mensagem
            if (!query) {
                searchResultsDiv.innerHTML = '';
                searchMessage.textContent = 'Por favor, digite um título para buscar.';
                searchMessage.classList.remove('hidden');
                return;
            }

            searchResultsDiv.innerHTML = ''; // Limpa quaisquer resultados de busca anteriores
            searchMessage.textContent = 'Buscando filmes no TMDB...'; // Exibe uma mensagem de carregamento
            searchMessage.classList.remove('hidden'); // Garante que a mensagem esteja visível

            try {
                // Faz a requisição à API do TMDB para buscar filmes
                const response = await fetch(`${BASE_TMDB_URL}/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}&language=pt-BR`);
                if (!response.ok) {
                    throw new Error(`Erro na busca: ${response.statusText}`);
                }
                const data = await response.json(); // Converte a resposta para JSON

                // Se nenhum resultado for encontrado no TMDB, sugere Google/IMDb
                if (data.results.length === 0) {
                    searchMessage.innerHTML = `
                        Nenhum filme encontrado no TMDB para a sua busca. Você pode tentar:
                        <br>
                        <a href="https://www.google.com/search?q=${encodeURIComponent(query)}%20filme" target="_blank" class="text-blue-400 hover:underline mt-2 inline-block">Buscar no Google por "${query}"</a>
                        <br>
                        <a href="https://www.imdb.com/find/?q=${encodeURIComponent(query)}&ref_=nv_sr_sm" target="_blank" class="text-blue-400 hover:underline mt-1 inline-block">Buscar no IMDb por "${query}"</a>
                    `;
                    searchMessage.classList.remove('hidden');
                    searchResultsDiv.innerHTML = ''; // Garante que não há resultados antigos do TMDB
                    return; // Sai da função após sugerir outras buscas
                }

                searchMessage.classList.add('hidden'); // Oculta a mensagem de busca uma vez que os resultados são carregados

                // Itera sobre os resultados e cria um card para cada filme
                data.results.forEach(movie => {
                    const movieCard = document.createElement('div');
                    movieCard.className = 'flex items-center bg-gray-600 rounded-lg p-3 shadow-md border border-gray-500';
                    movieCard.innerHTML = `
                        <img src="${movie.poster_path ? BASE_POSTER_URL + movie.poster_path : 'https://placehold.co/92x138/000000/FFFFFF?text=Sem+Poster'}" alt="${movie.title}" class="w-16 h-24 object-cover rounded-md mr-4 shadow-sm">
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-white">${movie.title}</h3>
                            <p class="text-gray-300 text-sm">${movie.release_date ? movie.release_date.substring(0, 4) : 'Ano Desconhecido'}</p>
                        </div>
                        <button class="add-movie-button bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105" data-movie-id="${movie.id}">
                            Adicionar
                        </button>
                    `;
                    searchResultsDiv.appendChild(movieCard);
                });

                // Adiciona um "listener" de evento para cada botão "Adicionar" recém-criado
                searchResultsDiv.querySelectorAll('.add-movie-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const movieId = event.target.dataset.movieId; // Obtém o ID do filme do atributo de dados
                        addMovie(movieId); // Chama a função para adicionar o filme
                        searchResultsDiv.innerHTML = ''; // Limpa os resultados da busca após adicionar um filme
                        movieSearchInput.value = ''; // Limpa o campo de input da busca
                        searchMessage.classList.add('hidden'); // Oculta a mensagem de busca
                    });
                });

            } catch (error) {
                // Captura e exibe erros que ocorrem durante a busca no TMDB
                console.error('Erro ao buscar filmes no TMDB:', error);
                searchMessage.textContent = `Erro ao buscar filmes no TMDB: ${error.message}`;
                searchMessage.classList.remove('hidden');
            }
        }

        /**
         * Adiciona um filme à lista de "filmes adicionados".
         * Busca detalhes completos do filme no TMDB antes de adicionar.
         * @param {string} movieId - O ID do filme no TMDB.
         */
        async function addMovie(movieId) {
            // Converte o movieId para número para garantir a comparação correta
            const numericMovieId = parseInt(movieId);
            // Verifica se o filme já foi adicionado para evitar duplicatas
            if (addedMovies.some(movie => movie.id === numericMovieId)) {
                showMessage('Este filme já foi adicionado!', 'bg-yellow-500');
                return;
            }

            try {
                // Faz a requisição para obter os detalhes completos de um filme pelo ID
                const response = await fetch(`${BASE_TMDB_URL}/movie/${numericMovieId}?api_key=${TMDB_API_KEY}&language=pt-BR`);
                if (!response.ok) {
                    throw new Error(`Erro ao buscar detalhes do filme: ${response.statusText}`);
                }
                const data = await response.json(); // Converte a resposta para JSON

                // Cria um objeto de filme com os dados relevantes
                const movie = {
                    id: data.id, // O ID do TMDB já é um número
                    title: data.title,
                    year: data.release_date ? data.release_date.substring(0, 4) : 'Ano Desconhecido',
                    overview: data.overview || 'Sinopse não disponível.', // Fallback para sinopse
                    poster_path: data.poster_path,
                    magnet_links: [''], // Inicializa com um array contendo um link magnet vazio para ser preenchido pelo usuário
                    direct_links: [''], // Adicionado novamente: Inicializa com um array contendo um link direto vazio
                    primaryTitleColor: 'silver', // Nova propriedade para a cor do título principal, padrão 'silver'
                    secondaryTitleColor: 'yellow', // Nova propriedade para a cor do título secundária, padrão 'yellow'
                    hdcamType: 'none' // Novo: 'none', 'leg', 'pt'
                };
                addedMovies.push(movie); // Adiciona o filme ao array de filmes adicionados
                renderAddedMovies(); // Atualiza a renderização da lista de filmes adicionados
                generateOutput(); // Atualiza o texto de saída gerado
                showMessage('Filme adicionado com sucesso!', 'bg-green-500'); // Exibe uma mensagem de sucesso

            } catch (error) {
                // Captura e exibe erros ao adicionar o filme
                console.error('Erro ao adicionar filme:', error);
                showMessage(`Erro ao adicionar filme: ${error.message}`, 'bg-red-500');
            }
        }

        /**
         * Remove um filme da lista de filmes adicionados.
         * @param {string} movieId - O ID do filme a ser removido.
         */
        function removeMovie(movieId) {
            // Converte o movieId para número para garantir a comparação correta
            const numericMovieId = parseInt(movieId);
            // Filtra o array `addedMovies`, removendo o filme com o ID correspondente
            addedMovies = addedMovies.filter(movie => movie.id !== numericMovieId);
            renderAddedMovies(); // Atualiza a renderização da lista
            generateOutput(); // Atualiza o texto de saída
            showMessage('Filme removido.', 'bg-gray-500'); // Exibe uma mensagem de remoção
        }

        /**
         * Adiciona um novo campo de link magnet para um filme específico.
         * @param {string} movieId - O ID do filme ao qual adicionar o link.
         */
        function addMagnetLink(movieId) {
            // Converte o movieId para número para garantir a comparação correta
            const numericMovieId = parseInt(movieId);
            const movie = addedMovies.find(m => m.id === numericMovieId);
            if (movie) {
                movie.magnet_links.push(''); // Adiciona um novo link vazio ao array
                renderAddedMovies(); // Re-renderiza para mostrar o novo campo de input
                generateOutput(); // Atualiza a saída
            }
        }

        /**
         * Remove um link magnet específico de um filme.
         * @param {string} movieId - O ID do filme do qual remover o link.
         * @param {number} linkIndex - O índice do link a ser removido no array.
         */
        function removeMagnetLink(movieId, linkIndex) {
            // Converte o movieId para número para garantir a comparação correta
            const numericMovieId = parseInt(movieId);
            const movie = addedMovies.find(m => m.id === numericMovieId);
            if (movie) {
                if (movie.magnet_links.length > 1) {
                    movie.magnet_links.splice(linkIndex, 1); // Remove o link pelo índice
                    showMessage('Link magnet removido.', 'bg-gray-500');
                } else if (movie.magnet_links.length === 1) {
                    movie.magnet_links[0] = ''; // Limpa o conteúdo do último link
                    showMessage('Último link magnet esvaziado.', 'bg-yellow-500');
                }
                renderAddedMovies(); // Re-renderiza
                generateOutput(); // Atualiza a saída
            }
        }

        /**
         * Adiciona um novo campo de link direto para um filme específico.
         * @param {string} movieId - O ID do filme ao qual adicionar o link.
         */
        function addDirectLink(movieId) {
            const numericMovieId = parseInt(movieId);
            const movie = addedMovies.find(m => m.id === numericMovieId);
            if (movie) {
                movie.direct_links.push(''); // Adiciona um novo link vazio ao array
                renderAddedMovies(); // Re-renderiza para mostrar o novo campo de input
                generateOutput(); // Atualiza a saída
            }
        }

        /**
         * Remove um link direto específico de um filme.
         * @param {string} movieId - O ID do filme do qual remover o link.
         * @param {number} linkIndex - O índice do link a ser removido no array.
         */
        function removeDirectLink(movieId, linkIndex) {
            const numericMovieId = parseInt(movieId);
            const movie = addedMovies.find(m => m.id === numericMovieId);
            if (movie) {
                if (movie.direct_links.length > 1) {
                    movie.direct_links.splice(linkIndex, 1); // Remove o link pelo índice
                    showMessage('Link direto removido.', 'bg-gray-500');
                } else if (movie.direct_links.length === 1) {
                    movie.direct_links[0] = ''; // Limpa o conteúdo do último link
                    showMessage('Último link direto esvaziado.', 'bg-yellow-500');
                }
                renderAddedMovies(); // Re-renderiza
                generateOutput(); // Atualiza a saída
            }
        }


        /**
         * Renderiza (desenha) a lista de filmes adicionados na interface do usuário.
         */
        function renderAddedMovies() {
            addedMoviesContainer.innerHTML = ''; // Limpa o container de filmes adicionados antes de renderizar novamente

            // Mostra ou esconde a mensagem "Nenhum filme adicionado ainda"
            if (addedMovies.length === 0) {
                noMoviesMessage.classList.remove('hidden');
            } else {
                noMoviesMessage.classList.add('hidden');
            }

            // Itera sobre cada filme no array `addedMovies` e cria o HTML correspondente
            addedMovies.forEach(movie => {
                const movieCard = document.createElement('div');
                movieCard.className = 'flex flex-col sm:flex-row items-start sm:items-center bg-gray-600 rounded-lg p-4 shadow-md border border-gray-500 relative';

                // Conteúdo principal do card do filme
                movieCard.innerHTML = `
                    <img src="${movie.poster_path ? BASE_POSTER_URL + movie.poster_path : 'https://placehold.co/92x138/000000/FFFFFF?text=Sem+Poster'}" alt="${movie.title}" class="w-24 h-36 object-cover rounded-md mr-4 mb-4 sm:mb-0 shadow-sm flex-shrink-0">
                    <div class="flex-grow">
                        <h3 class="text-xl font-semibold text-white mb-1">${movie.title} <span class="text-gray-300 text-sm">(${movie.year})</span></h3>
                        <p class="text-gray-300 text-sm mb-3 line-clamp-3">${movie.overview}</p>
                        
                        <div class="flex items-center gap-2 mb-3">
                            <label for="primaryTitleColor-${movie.id}" class="text-gray-300 text-sm flex-shrink-0">Cor Título Principal:</label>
                            <input type="text" id="primaryTitleColor-${movie.id}" class="primary-title-color-input flex-grow p-2 rounded-lg bg-gray-700 border border-gray-500 focus:ring-1 focus:ring-blue-500 text-white text-sm" placeholder="Ex: silver" value="${movie.primaryTitleColor || 'silver'}" data-movie-id="${movie.id}">
                        </div>
                        <div class="flex items-center gap-2 mb-3">
                            <label for="secondaryTitleColor-${movie.id}" class="text-gray-300 text-sm flex-shrink-0">Cor Título Secundário:</label>
                            <input type="text" id="secondaryTitleColor-${movie.id}" class="secondary-title-color-input flex-grow p-2 rounded-lg bg-gray-700 border border-gray-500 focus:ring-1 focus:ring-blue-500 text-white text-sm" placeholder="Ex: yellow" value="${movie.secondaryTitleColor || 'yellow'}" data-movie-id="${movie.id}">
                        </div>

                        <!-- Dropdown para tipo de HDCAM, agora sempre visível -->
                        <div class="flex items-center gap-2 mb-4">
                            <label for="hdcamType-${movie.id}" class="text-gray-300 text-sm flex-shrink-0">Tipo de HDCAM:</label>
                            <select id="hdcamType-${movie.id}" class="hdcam-type-select flex-grow p-2 rounded-lg bg-gray-700 border border-gray-500 focus:ring-1 focus:ring-green-500 text-white text-sm" data-movie-id="${movie.id}">
                                <option value="none" ${movie.hdcamType === 'none' ? 'selected' : ''}>Nenhum</option>
                                <option value="leg" ${movie.hdcamType === 'leg' ? 'selected' : ''}>HDCAM LEG.</option>
                                <option value="pt" ${movie.hdcamType === 'pt' ? 'selected' : ''}>HDCAM PT.</option>
                            </select>
                        </div>

                        <div class="magnet-links-section space-y-2 mb-4">
                            <label class="text-gray-300 text-sm">Links Magnet:</label>
                            <div class="magnet-inputs-container space-y-2">
                                <!-- Links magnet serão inseridos aqui dinamicamente -->
                            </div>
                            <button class="add-magnet-link-button bg-purple-700 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-sm" data-movie-id="${movie.id}">
                                Adicionar Link Magnet
                            </button>
                        </div>

                        <div class="direct-links-section space-y-2 mb-4">
                            <label class="text-gray-300 text-sm">Links Diretos (HTTP/HTTPS):</label>
                            <div class="direct-inputs-container space-y-2">
                                <!-- Links diretos serão inseridos aqui dinamicamente -->
                            </div>
                            <button class="add-direct-link-button bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-sm" data-movie-id="${movie.id}">
                                Adicionar Link Direto
                            </button>
                        </div>
                    </div>
                    <!-- Botão de remover filme -->
                    <button class="remove-movie-button absolute top-3 right-3 bg-red-600 hover:bg-red-700 text-white p-2 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-110" data-movie-id="${movie.id}" title="Remover Filme">
                        <!-- Ícone de remover SVG -->
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
                addedMoviesContainer.appendChild(movieCard);

                // Adiciona os inputs de link magnet dinamicamente
                const magnetInputsContainer = movieCard.querySelector('.magnet-inputs-container');
                movie.magnet_links.forEach((link, index) => {
                    const linkDiv = document.createElement('div');
                    linkDiv.className = 'flex items-center gap-2';
                    linkDiv.innerHTML = `
                        <input type="text" class="magnet-link-input flex-grow p-2 rounded-lg bg-gray-700 border border-gray-500 focus:ring-1 focus:ring-blue-500 text-white text-sm" placeholder="Cole o link magnet aqui (ex: magnet:?xt=...$nome=[COLOR lime]Nome[/COLOR])..." value="${link || ''}" data-movie-id="${movie.id}" data-link-index="${index}">
                        <button class="remove-single-magnet-button bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105" data-movie-id="${movie.id}" data-link-index="${index}" title="Remover este link">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    `;
                    magnetInputsContainer.appendChild(linkDiv);
                });

                // Adiciona os inputs de link direto dinamicamente
                const directInputsContainer = movieCard.querySelector('.direct-inputs-container');
                movie.direct_links.forEach((link, index) => {
                    const linkDiv = document.createElement('div');
                    linkDiv.className = 'flex items-center gap-2';
                    linkDiv.innerHTML = `
                        <input type="text" class="direct-link-input flex-grow p-2 rounded-lg bg-gray-700 border border-gray-500 focus:ring-1 focus:ring-blue-500 text-white text-sm" placeholder="Cole o link direto aqui (http/https)..." value="${link || ''}" data-movie-id="${movie.id}" data-link-index="${index}">
                        <button class="remove-single-direct-button bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105" data-movie-id="${movie.id}" data-link-index="${index}" title="Remover este link">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    `;
                    directInputsContainer.appendChild(linkDiv);
                });
            });

            // Adiciona "listeners" de evento para os inputs de link magnet
            addedMoviesContainer.querySelectorAll('.magnet-link-input').forEach(input => {
                input.addEventListener('input', (event) => {
                    const movieId = event.target.dataset.movieId;
                    const linkIndex = parseInt(event.target.dataset.linkIndex);
                    const newMagnetLink = event.target.value;
                    const movie = addedMovies.find(m => m.id === parseInt(movieId));
                    if (movie && movie.magnet_links[linkIndex] !== undefined) {
                        movie.magnet_links[linkIndex] = newMagnetLink;
                        generateOutput(); // Regenera a saída sempre que um link magnet é atualizado
                    }
                });
            });

            // Adiciona "listeners" de evento para os inputs de link direto
            addedMoviesContainer.querySelectorAll('.direct-link-input').forEach(input => {
                input.addEventListener('input', (event) => {
                    const movieId = event.target.dataset.movieId;
                    const linkIndex = parseInt(event.target.dataset.linkIndex);
                    const newDirectLink = event.target.value;
                    const movie = addedMovies.find(m => m.id === parseInt(movieId));
                    if (movie && movie.direct_links[linkIndex] !== undefined) {
                        movie.direct_links[linkIndex] = newDirectLink;
                        generateOutput(); // Regenera a saída sempre que um link direto é atualizado
                    }
                });
            });

            // Adiciona "listeners" de evento para os inputs de cor do título principal
            addedMoviesContainer.querySelectorAll('.primary-title-color-input').forEach(input => {
                input.addEventListener('input', (event) => {
                    const movieId = event.target.dataset.movieId;
                    const newColor = event.target.value.trim();
                    const movie = addedMovies.find(m => m.id === parseInt(movieId));
                    if (movie) {
                        movie.primaryTitleColor = newColor;
                        generateOutput(); // Regenera a saída sempre que a cor do título é atualizada
                    }
                });
            });

            // Adiciona "listeners" de evento para os inputs de cor do título secundário
            addedMoviesContainer.querySelectorAll('.secondary-title-color-input').forEach(input => {
                input.addEventListener('input', (event) => {
                    const movieId = event.target.dataset.movieId;
                    const newColor = event.target.value.trim();
                    const movie = addedMovies.find(m => m.id === parseInt(movieId));
                    if (movie) {
                        movie.secondaryTitleColor = newColor;
                        generateOutput(); // Regenera a saída sempre que a cor do título é atualizada
                    }
                });
            });

            // Adiciona "listeners" de evento para o select de tipo de HDCAM
            addedMoviesContainer.querySelectorAll('.hdcam-type-select').forEach(select => {
                select.addEventListener('change', (event) => {
                    const movieId = event.target.dataset.movieId;
                    const newHdcamType = event.target.value;
                    const movie = addedMovies.find(m => m.id === parseInt(movieId));
                    if (movie) {
                        movie.hdcamType = newHdcamType;
                        generateOutput(); // Regenera a saída quando o tipo de HDCAM muda
                    }
                });
            });

            // Adiciona "listeners" de evento para os botões "Adicionar Link Magnet"
            addedMoviesContainer.querySelectorAll('.add-magnet-link-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const movieId = event.currentTarget.dataset.movieId;
                    addMagnetLink(movieId);
                });
            });

            // Adiciona "listeners" de evento para os botões "Remover este link" (magnet)
            addedMoviesContainer.querySelectorAll('.remove-single-magnet-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const movieId = event.currentTarget.dataset.movieId;
                    const linkIndex = parseInt(event.currentTarget.dataset.linkIndex);
                    removeMagnetLink(movieId, linkIndex);
                });
            });

            // Adiciona "listeners" de evento para os botões "Adicionar Link Direto"
            addedMoviesContainer.querySelectorAll('.add-direct-link-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const movieId = event.currentTarget.dataset.movieId;
                    addDirectLink(movieId);
                });
            });

            // Adiciona "listeners" de evento para os botões "Remover este link" (direto)
            addedMoviesContainer.querySelectorAll('.remove-single-direct-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const movieId = event.currentTarget.dataset.movieId;
                    const linkIndex = parseInt(event.currentTarget.dataset.linkIndex);
                    removeDirectLink(movieId, linkIndex);
                });
            });

            // Adiciona "listeners" de evento para os botões "Remover Filme" (o grande 'X')
            addedMoviesContainer.querySelectorAll('.remove-movie-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const movieId = event.currentTarget.dataset.movieId;
                    removeMovie(movieId); // Chama a função para remover o filme
                });
            });
        }

        /**
         * Gera o texto formatado com as informações dos filmes e links (magnet e/ou diretos)
         * para ser copiado e utilizado com o Kodi, baseado na estrutura selecionada para os links magnet.
         */
        function generateOutput() {
            let output = '';
            // Se não houver filmes adicionados, exibe uma mensagem padrão
            if (addedMovies.length === 0) {
                generatedOutputTextarea.value = 'Adicione filmes para gerar o conteúdo para Kodi.';
                return;
            }

            addedMovies.forEach(movie => {
                const movieTitle = movie.title;
                const movieYear = movie.year;
                let overview = movie.overview || 'Sinopse não disponível.';
                const posterUrl = movie.poster_path ? BASE_POSTER_URL + movie.poster_path : 'https://placehold.co/92x138/000000/FFFFFF?text=Sem+Poster';
                const primaryColor = movie.primaryTitleColor || 'silver';
                const secondaryColor = movie.secondaryTitleColor || 'yellow';

                let hdcamText = '';
                if (movie.hdcamType === 'leg') {
                    hdcamText = '( HDCAM LEG. )';
                } else if (movie.hdcamType === 'pt') {
                    hdcamText = '( HDCAM PT. )';
                }

                let primaryPlayableLink = ''; // Este será o primeiro link válido para a tag <link> principal
                let allLinksInfo = []; // Para coletar todos os links para a seção <info>

                // Coleta Links Magnet
                movie.magnet_links.forEach((link, index) => {
                    const magnetUri = link.trim();
                    if (magnetUri) {
                        if (!primaryPlayableLink) {
                            primaryPlayableLink = `plugin://plugin.video.elementum/play?uri=${magnetUri}`;
                        }
                        allLinksInfo.push(`[COLOR yellow]Magnet ${index + 1}:[/COLOR] [COLOR lime]${magnetUri}[/COLOR]`);
                    }
                });

                // Coleta Links Diretos
                movie.direct_links.forEach((link, index) => {
                    const directUrl = link.trim();
                    if (directUrl) {
                        if (!primaryPlayableLink) { // Se nenhum link magnet foi encontrado, usa o primeiro link direto
                            primaryPlayableLink = directUrl;
                        }
                        allLinksInfo.push(`[COLOR yellow]Direto ${index + 1}:[/COLOR] [COLOR lime]${directUrl}[/COLOR]`);
                    }
                });

                // Anexa todos os links coletados à sinopse para a tag <info>
                if (allLinksInfo.length > 0) {
                    overview += `\n\n[B][COLOR lightblue]Links para Reprodução:[/COLOR][/B]\n`;
                    overview += allLinksInfo.join('\n');
                }

                // Decide o formato do título baseado na estrutura de saída selecionada
                let titleContent = '';
                let genreContent = ''; // Para estruturas BXL e allan
                let infoContent = overview; // Conteúdo de info padrão

                if (currentOutputStructure === 'will') {
                    titleContent = `[COLOR ${primaryColor}][B]${movieTitle} (${movieYear})${hdcamText}[/COLOR][/B][COLOR ${secondaryColor}][B][/COLOR][/B]`;
                } else if (currentOutputStructure === 'BXL') {
                    const bxlPrimaryColor = 'blue';
                    const bxlSecondaryColor = 'red';
                    const bxlGenreColor = 'firebrick';
                    titleContent = `[B][COLOR ${bxlPrimaryColor}] ${movieTitle} - [COLOR ${bxlSecondaryColor}]ADDON BXL [COLOR ${bxlSecondaryColor}](${movieYear})${hdcamText} Dual Áudio / Dublado 5.1 BluRay 720p | 1080p | 3D | 4K | 2160p [/COLOR][/B]`;
                    genreContent = `    <genre>[B][COLOR ${bxlGenreColor}] ADDON BXL O profissional dessa área atua no desenvolvimento de softwares e no manejo de estruturas e sistemas informatizados. Tecnologia da Informação.[/COLOR][/B]</genre>\n`;
                    infoContent = `[B][COLOR ${bxlSecondaryColor}] SINOPSE:${overview}[COLOR ${bxlSecondaryColor}][/COLOR][/B]`;
                } else if (currentOutputStructure === 'allan') {
                    const allanPrimaryColor = 'silver';
                    const allanSecondaryColor = 'yellow';
                    const allanGenreColor = 'firebrick';
                    titleContent = `[COLOR ${allanPrimaryColor}][B] ${movieTitle} ${hdcamText} [/COLOR][/B][COLOR ${allanSecondaryColor}] FULL HD [B][/COLOR][/B]`;
                    genreContent = `    <genre>[B][COLOR ${allanGenreColor}] Coleção de Filmes - O profissional dessa área atua no desenvolvimento de softwares e no manejo de estruturas e sistemas informatizados. Tecnologia da Informação.[/COLOR][/B]</genre>\n`;
                    infoContent = `[B][COLOR red] SINOPSE:${overview}[COLOR red][/COLOR][/B]`;
                }

                // Constrói o único bloco <item>
                if (primaryPlayableLink) { // Somente gera <item> se houver pelo menos um link
                    output += `<item>\n`;
                    output += `    <title>${titleContent}</title>\n`;
                    output += `    <link>${primaryPlayableLink}</link>\n`;
                    output += `    <thumbnail>${posterUrl}</thumbnail>\n`;
                    output += genreContent; // Adiciona gênero se aplicável (BXL/allan)
                    output += `    <fanart>${posterUrl}</fanart>\n`;
                    output += `    <info><![CDATA[${infoContent}]]></info>\n`;
                    output += `</item>\n\n`;
                }
            });
            generatedOutputTextarea.value = output.trim();
        }

        /**
         * Copia o texto da área de saída gerada para a área de transferência do usuário.
         */
        function copyOutput() {
            // Verifica se há conteúdo para copiar
            if (generatedOutputTextarea.value.trim() === '' || generatedOutputTextarea.value.trim() === 'Adicione filmes para gerar o conteúdo para Kodi.') {
                showMessage('Não há conteúdo para copiar.', 'bg-yellow-500');
                return;
            }
            try {
                generatedOutputTextarea.select(); // Seleciona todo o texto na área de texto
                document.execCommand('copy'); // Executa o comando de cópia (compatibilidade mais ampla em iframes)
                showMessage('Conteúdo copiado para a área de transferência!', 'bg-blue-500'); // Mensagem de sucesso
            } catch (err) {
                console.error('Erro ao copiar: ', err);
                showMessage('Falha ao copiar o conteúdo.', 'bg-red-500'); // Mensagem de erro
            }
        }

        /**
         * Exibe uma mensagem temporária de notificação na tela.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} bgColorClass - Classe de cor de fundo do Tailwind (ex: 'bg-green-500').
         */
        function showMessage(message, bgColorClass) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed bottom-6 right-6 p-4 rounded-lg shadow-lg text-white font-semibold transition-opacity duration-300 ease-out z-50 ${bgColorClass}`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);

            // Remove a mensagem após um período de tempo
            setTimeout(() => {
                messageDiv.style.opacity = '0'; // Inicia a transição de opacidade para desaparecer
                messageDiv.addEventListener('transitionend', () => messageDiv.remove()); // Remove o elemento do DOM após a transição
            }, 3000); // Mensagem visível por 3 segundos
        }

        // Adiciona "listeners" de evento para os botões e inputs principais
        searchMovieButton.addEventListener('click', () => searchMovies(movieSearchInput.value.trim()));
        movieSearchInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') { // Permite buscar ao pressionar Enter no campo de busca
                searchMovies(movieSearchInput.value.trim());
            }
        });
        copyOutputButton.addEventListener('click', copyOutput); // Adiciona listener para o botão de copiar

        // Adiciona "listeners" de evento para os rádios de seleção de estrutura de saída
        document.querySelectorAll('.output-structure-radio').forEach(radio => {
            radio.addEventListener('change', (event) => {
                currentOutputStructure = event.target.value;
                renderAddedMovies(); // Re-renderiza para mostrar/esconder o select de HDCAM
                generateOutput(); // Gera a saída com base na nova seleção
            });
        });

        // Inicializa a interface quando a página é completamente carregada
        document.addEventListener('DOMContentLoaded', () => {
            renderAddedMovies(); // Renderiza qualquer filme que possa estar no estado inicial (vazio aqui)
            generateOutput(); // Gera a saída inicial (mensagem de "nenhum filme")
        });
    </script>
</body>
</html>
